import path from 'path';

import {
  appendFunctionCall,
  TEST_FILE,
  writeImportString,
} from '../test_utils';

const circom_tester = require('circom_tester');
const wasm_tester = circom_tester.wasm;

const IMPORT_STRING = `pragma circom 2.1.7;
include "../../circuit/sisu/fri/domain.circom";
include "../../circuit/sisu/fri/fold.circom";
include "../../circuit/sisu/fri/fri.circom";
`;
const FOLDER_NAME = "fri";

describe("FRI", function () {
  jest.setTimeout(1000 * 1000);

  beforeEach(async function () {
    writeImportString(FOLDER_NAME, IMPORT_STRING);
  });

  // Verify GetFRIDomainElement
  it("VerifyGetFRIDomainElement", async function () {
    appendFunctionCall(FOLDER_NAME, `component main = GetFRIDomainElement(0, 0);`);
    const circuit = await wasm_tester(
      path.join(__dirname, '.', TEST_FILE)
    );
    let witness;

    witness = await circuit.calculateWitness({
      "pow": 4,
    });
    await circuit.assertOut(witness, { "out": "14940766826517323942636479241147756311199852622225275649687664389641784935947" });
  });

  // Verify Fold
  it("VerifyFold", async function () {
    appendFunctionCall(FOLDER_NAME, `component main = FRIFoldEvaluation(0, 0);`);
    const circuit = await wasm_tester(
      path.join(__dirname, '.', TEST_FILE)
    );
    let witness;

    witness = await circuit.calculateWitness({
      "r__inverse_two__inverse_domain_element": "16579383480843040346",
      "positive_evaluation": "18446181119461163007",
      "negative_evaluation": "562949953421310"
    });
    await circuit.assertOut(witness, { "out": "10944121435919637611123202872628637544579999177381492064605480124092529047129" });
  });

  // Verify FRI
  it("VerifyFRI", async function () {
    appendFunctionCall(FOLDER_NAME, `component main {public [index]} = VerifyMultiFRI(0);`);
    const circuit = await wasm_tester(
      path.join(__dirname, '.', TEST_FILE)
    );
    let witness;

    witness = await circuit.calculateWitness({
      "commitment_transcript": ["4263659307527170635364136053938104526606238211196004623538185109970006698963", "20574681665109181408004174462666758840821974699882652646778286169316709919608", "20154104753936252724928882060529067374302721101931121444031243764496916861008", "719324782424570455341659269814331683237187882763530483206034316555696545546", "1438649564849140910683318539628663366474375765527060966412068633111393091092"],
      "query_transcript": ["6044254923388122124737912129580344197123642511754961599151261243332815991464", "12088509846776244249475824259160688394247285023509923198302522486665631982928", "7999965736428448656216409465325261407937381672711807820205116489677521696704", "18341761769676173507940852574082285673274496535137855622684137056228699263910", "21741938418994841831020780942965843146132806680953386628624024270037423925429", "14765450429699835226629627433448527273226536151538272191612151869598799997797", "20651852269538984840834758069090996531044192892783258270800987678819042274824", "12647695084703366496003546009939062203258089907876401573554156308799864519309", "10352954086389193539532925489337980125134135924472277626933233363711818749303", "20705908172778387079065850978675960250268271848944555253866466727423637498606", "16600298434557887348398056232641545598664426147096822249435042780865801633765", "14303481783929338483754778801768957716690106224791681566782551889473820020321", "20078818959265001277331693088318599324638116349226309100556100692830686170739", "3561088901237309965757782704879757047291438916033760883779822926579672355823", "4049948115186798710253243724263356379477776115846807300068024396459153222168", "18015731886849155675486272287279277959098657286762368687279045614848110950404", "16566617600508240455309279718895620679651412589020825228901412046197729938840", "11244992329177205688372153692533966270754460777625616114104619905819651382063", "20150958098134714701800367411401071813087267395153131367279117991342587812626", "14703083178962674282348395896300582914067286635031414548733751302928781252199", "21820518551668700145295332089083456662214605914399558774896792151510027090325", "16792560559754799106654296373300554642106434115572559891535081632476848405194", "11003651554019942385851135326766376980740654784390800355467863272153603145100", "10557590538376769466883236950436262274933967387936022547926892408801014839955", "21115181076753538933766473900872524549867934775872045095853784817602029679910", "6799760794156335065442539983947882344197602387902040074663999329446010839408", "18755900187584635704591251600896708918248325348386364343052339510711374659678", "15146123008287074176025054491757797057419947319870537092196614768714302438601", "2730907931088425988812864428133700015289511117370673207488100591210054272721", "8346307450200412171893457507900951017801754171393074002103323968063998366469", "4231852869245271484327206260486346407818704863959665115277090514752535599766", "8463705738490542968654412520972692815637409727919330230554181029505071199532", "16803102307722387569563780206662335273937845067955792723826181909061233221365", "16260977129232343963911449931094040934700655531778853663177758443288376156534", "7711830524741502011581951792636726738822403720890052588980599600357182881670", "20060705456577191344683084417384241366187029948741095852299851905264890576739", "18549505616484936905988530256283411338008998370956047310666407697727453330143", "15210768361130598589730654767309547587469632341496060277634611208879098164669", "711441331400592334155471006123776570800445576180813659728148807214572018003", "21080112029825690249637365425781890159200379513419387289646204990293030196192", "18551381778385512483101310483992086419805722372601652545215587655114173788494", "11635822154602134933527874164800976403570182624790073937771248328352235287544"],
      "first_z_evaluations": ["4555080543920641138110631935230932765199409518337779736461984787907073590564", "9110161087841282276221263870461865530398819036675559472923969575814147181128"],
      "first_op_z_evaluations": ["7533429302855603111365192323929755629047875505172143461840537698758558392364", "15066858605711206222730384647859511258095751010344286923681075397517116784728"],
      "trusted_r": ["0", "14434907590961039114924555961227647345447940211889801831437187669161666809225", "3911858157684771295493741929088324607974089887658210254977322031811735453033", "16938758862219192219812607128597345302345453954882022648320841625200657911293"],
      "index": 1,
    });
    await circuit.assertOut(witness, {});
  });
});
